# Omniphi Cloud Prometheus Configuration

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    cluster: 'omniphi-cloud'
    env: 'production'

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093

# Load alert rules
rule_files:
  - /etc/prometheus/alerts/*.yml

# Scrape configurations
scrape_configs:
  # ============================================
  # PROMETHEUS SELF-MONITORING
  # ============================================
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
    metrics_path: /metrics
    scheme: http

  # ============================================
  # NODE EXPORTER - Host Metrics
  # ============================================
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['node-exporter:9100']
    relabel_configs:
      - source_labels: [__address__]
        target_label: instance
        regex: '([^:]+):\d+'
        replacement: '${1}'

  # ============================================
  # CADVISOR - Container Metrics
  # ============================================
  - job_name: 'cadvisor'
    static_configs:
      - targets: ['cadvisor:8080']

  # ============================================
  # OMNIPHI ORCHESTRATOR BACKEND
  # ============================================
  - job_name: 'orchestrator-backend'
    metrics_path: /metrics
    static_configs:
      - targets: ['host.docker.internal:8000']
        labels:
          service: 'orchestrator'
          component: 'backend'

  # ============================================
  # VALIDATOR NODES (Dynamic Discovery)
  # ============================================
  - job_name: 'validator-nodes'
    metrics_path: /metrics
    file_sd_configs:
      - files:
          - /etc/prometheus/targets/validators.json
        refresh_interval: 30s
    relabel_configs:
      - source_labels: [__meta_node_id]
        target_label: node_id
      - source_labels: [__meta_region]
        target_label: region
      - source_labels: [__meta_moniker]
        target_label: moniker

  # ============================================
  # TENDERMINT/COMETBFT METRICS
  # ============================================
  - job_name: 'tendermint'
    metrics_path: /metrics
    file_sd_configs:
      - files:
          - /etc/prometheus/targets/tendermint.json
        refresh_interval: 30s
    relabel_configs:
      - source_labels: [__meta_node_id]
        target_label: node_id
      - source_labels: [__meta_chain_id]
        target_label: chain_id

  # ============================================
  # COSMOS SDK APP METRICS
  # ============================================
  - job_name: 'cosmos-app'
    metrics_path: /metrics
    scheme: http
    file_sd_configs:
      - files:
          - /etc/prometheus/targets/cosmos-app.json
        refresh_interval: 30s

  # ============================================
  # ALERTMANAGER
  # ============================================
  - job_name: 'alertmanager'
    static_configs:
      - targets: ['alertmanager:9093']

  # ============================================
  # GRAFANA
  # ============================================
  - job_name: 'grafana'
    static_configs:
      - targets: ['grafana:3000']

  # ============================================
  # LOKI
  # ============================================
  - job_name: 'loki'
    static_configs:
      - targets: ['loki:3100']
