# Omniphi CI Pipeline
# Comprehensive testing, linting, and security scanning

name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  GO_VERSION: "1.23"

jobs:
  # Lint and format check
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          working-directory: ./chain
          args: --timeout=5m

  # Unit tests
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run unit tests
        working-directory: ./chain
        run: |
          go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./chain/coverage.out
          flags: unittests
          fail_ci_if_error: false

  # Integration tests
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run integration tests
        working-directory: ./chain
        run: |
          go test -v -tags=integration -timeout=30m ./test/integration/...

  # Security scanning
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run govulncheck
        working-directory: ./chain
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

      - name: Run gosec
        uses: securego/gosec@master
        with:
          args: -exclude-dir=test -exclude-dir=testutil ./chain/...

  # Build verification
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [lint, test]
    strategy:
      matrix:
        os: [linux, darwin]
        arch: [amd64, arm64]
        exclude:
          - os: linux
            arch: arm64  # Skip linux/arm64 for speed
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Build binary
        working-directory: ./chain
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          CGO_ENABLED: 0
        run: |
          go build -ldflags="-s -w" -o posd-${{ matrix.os }}-${{ matrix.arch }} ./cmd/posd

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: posd-${{ matrix.os }}-${{ matrix.arch }}
          path: ./chain/posd-${{ matrix.os }}-${{ matrix.arch }}

  # Proto validation
  proto:
    name: Proto Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Install buf
        uses: bufbuild/buf-setup-action@v1

      - name: Buf lint
        working-directory: ./chain
        run: buf lint proto

      - name: Check generated files
        working-directory: ./chain
        run: |
          make proto-gen
          git diff --exit-code || (echo "Proto files are out of sync. Run 'make proto-gen' and commit." && exit 1)

  # Wallet tests
  wallet-test:
    name: Wallet Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./wallet
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ./wallet/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run lint || true  # Don't fail on lint for now

      - name: Build
        run: npm run build

  # Explorer tests
  explorer-test:
    name: Explorer Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./services/explorer
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: ./services/explorer/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

  # Summary job
  ci-complete:
    name: CI Complete
    runs-on: ubuntu-latest
    needs: [lint, test, build, security, wallet-test, explorer-test]
    steps:
      - name: CI Summary
        run: |
          echo "All CI checks passed!"
          echo "- Linting: ✅"
          echo "- Unit Tests: ✅"
          echo "- Build: ✅"
          echo "- Security: ✅"
          echo "- Wallet: ✅"
          echo "- Explorer: ✅"
